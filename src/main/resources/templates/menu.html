<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org">
<head>
    <title>–û–Ω–ª–∞–π–Ω –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞</title>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.1.3/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.1/css/all.min.css">
    <link rel="icon"
          href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üìö</text></svg>">
    <style>
        .book-card {
            transition: transform 0.2s;
            height: 100%;
        }

        .book-card:hover {
            transform: translateY(-5px);
        }

        .card-img-top {
            height: 300px;
            object-fit: cover;
        }
    </style>
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-light" style="background-color: #007bff;">
    <div class="container-fluid">
        <a class="navbar-brand" th:href="@{/view/books}" style="color: white;">üìö –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞</a>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav ms-auto">
                <!-- –ö–Ω–æ–ø–∫–∞ –¥–ª—è –∞–¥–º–∏–Ω–∞ -->
                <li class="nav-item" th:if="${userRole == 'ROLE_ADMIN'}">
                    <a class="nav-link" href="/swagger-ui.html" style="color: white;">
                        <i class="fa-solid fa-gear"></i> Swagger
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" th:href="@{/profile}" style="color: white;"><i class="fa-solid fa-person"></i> –ü—Ä–æ—Ñ–∏–ª—å</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" th:href="@{/logout}" style="color: white;">–í—ã—Ö–æ–¥</a>
                </li>
            </ul>
        </div>
    </div>
</nav>

<div class="container mt-5">
    <h1 class="text-center mb-4">–ö–Ω–∏–∂–Ω–∞—è –∫–æ–ª–ª–µ–∫—Ü–∏—è</h1>

    <!-- –ü–æ–∏—Å–∫ –∏ —Ñ–∏–ª—å—Ç—Ä -->
    <div class="row mb-4">
        <div class="col-md-8 mx-auto">
            <form th:action="@{/view/books/search}" method="GET" class="d-flex">
                <div class="input-group">
                    <input type="text" class="form-control"
                           placeholder="–ü–æ–∏—Å–∫ –ø–æ –∫–Ω–∏–≥–∞–º..."
                           name="query"
                           th:value="${query != null} ? ${query} : ''">
                    <span class="input-group-text" style="cursor: pointer; " onclick="clearSearch()">
                    √ó
                </span>
                    <!-- –°–∫—Ä—ã—Ç–æ–µ –ø–æ–ª–µ –¥–ª—è –ø–µ—Ä–µ–¥–∞—á–∏ –∂–∞–Ω—Ä–∞ -->
                    <input type="hidden" name="genre" th:value="${genre != null} ? ${genre} : ''">
                    <button class="btn btn-primary" type="submit">
                        –ù–∞–π—Ç–∏
                    </button>
                    <!-- –ö–Ω–æ–ø–∫–∞ "–§–∏–ª—å—Ç—Ä" -->
                    <div class="btn-group" style="margin-left: 0.5cm;">
                        <button type="button" class="btn btn-secondary dropdown-toggle"
                                data-bs-toggle="dropdown" aria-expanded="false">
                            –§–∏–ª—å—Ç—Ä –ø–æ –∂–∞–Ω—Ä—É
                        </button>
                        <ul class="dropdown-menu">
                            <li>
                                <a class="dropdown-item"
                                   th:href="@{/view/books/search(query=${query}, genre=, page=0)}">
                                    –í—Å–µ –∂–∞–Ω—Ä—ã
                                </a>
                            </li>
                            <li th:each="genre : ${genres}">
                                <a class="dropdown-item"
                                   th:href="@{/view/books/search(query=${query}, genre=${genre}, page=0)}"
                                   th:text="${genre}"></a>
                            </li>
                        </ul>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <script>
        function clearSearch() {
            document.getElementsByName('query')[0].value = '';
            document.location.href = '/view/books/search';
        }
    </script>

    <!-- –ö–Ω–∏–≥–∏ -->
    <div th:if="${books != null and !books.isEmpty()}">
        <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
            <div th:each="book : ${books}" class="col">
                <div class="card h-100 book-card shadow-sm"
                     th:style="${book.booked} ? 'background-color: #ffebee; border: 1px solid #ffcdd2;' : ''">
                    <div class="card-body">
                        <h5 class="card-title" th:text="${book.title}">–ù–∞–∑–≤–∞–Ω–∏–µ –∫–Ω–∏–≥–∏</h5>
                        <h6 class="card-subtitle mb-2 text-muted" th:text="${book.author}">–ê–≤—Ç–æ—Ä</h6>
                        <div class="mb-3">
                            <span class="badge bg-primary" th:text="${book.genre}">–ñ–∞–Ω—Ä</span>
                        </div>
                        <!-- –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–∏ -->
                        <div th:if="${book.booked}" class="alert alert-danger mt-2">
                            <p>–ö–Ω–∏–≥–∞ –∑–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∞.</p>
                            <p>–ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∞ –¥–æ:
                                <span th:text="${book.bookedBefore != null} ? ${#temporals.format(book.bookedBefore, 'dd.MM.yyyy')} : '–î–∞—Ç–∞ –Ω–µ —É–∫–∞–∑–∞–Ω–∞'"></span>
                            </p>
                        </div>
                    </div>
                    <div class="card-footer bg-transparent">
                        <button class="btn btn-outline-primary"
                                data-bs-toggle="modal"
                                data-bs-target="#bookDetailsModal"
                                th:data-title="${book.title}"
                                th:data-author="${book.author}"
                                th:data-genre="${book.genre}"
                                th:data-description="${book.description != null} ? ${book.description} : '–ù–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è'"
                                th:data-date="${#temporals.format(book.publicationDate, 'dd.MM.yyyy')}"
                                th:data-booked="${book.booked}"> <!-- –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è -->
                            –ü–æ–¥—Ä–æ–±–Ω–µ–µ
                        </button>
                        <small class="text-muted float-end"
                               th:text="${#temporals.format(book.publicationDate, 'dd.MM.yyyy')}">
                            [[${#temporals.format(book.publicationDate, 'dd.MM.yyyy')}]]
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- –°–æ–æ–±—â–µ–Ω–∏–µ, –µ—Å–ª–∏ –∫–Ω–∏–≥–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã -->
    <div th:if="${books == null or books.isEmpty()}" class="alert alert-warning mt-4">
        <span th:if="${message != null}" th:text="${message}"></span>
        <span th:if="${message == null}">–ö–Ω–∏–≥–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</span>
    </div>

    <!-- –ü–∞–≥–∏–Ω–∞—Ü–∏—è -->
    <nav th:if="${totalPages != null and totalPages > 1}" class="mt-5">
        <ul class="pagination justify-content-center">
            <!-- –ö–Ω–æ–ø–∫–∞ "–ù–∞–∑–∞–¥" -->
            <li class="page-item" th:classappend="${currentPage == 0} ? 'disabled'">
                <a class="page-link"
                   th:href="@{/view/books/search(query=${query}, genre=${genre}, page=${currentPage - 1})}">
                    –ù–∞–∑–∞–¥
                </a>
            </li>

            <!-- –ù–æ–º–µ—Ä–∞ —Å—Ç—Ä–∞–Ω–∏—Ü -->
            <li class="page-item" th:each="pageNumber : ${#numbers.sequence(1, totalPages)}"
                th:classappend="${pageNumber - 1 == currentPage} ? 'active'">
                <a class="page-link"
                   th:href="@{/view/books/search(query=${query}, genre=${genre}, page=${pageNumber - 1})}"
                   th:text="${pageNumber}"></a>
            </li>

            <!-- –ö–Ω–æ–ø–∫–∞ "–í–ø–µ—Ä–µ–¥" -->
            <li class="page-item" th:classappend="${currentPage == totalPages - 1} ? 'disabled'">
                <a class="page-link"
                   th:href="@{/view/books/search(query=${query}, genre=${genre}, page=${currentPage + 1})}">
                    –í–ø–µ—Ä–µ–¥
                </a>
            </li>
        </ul>
    </nav>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å –¥–µ—Ç–∞–ª—è–º–∏ –∫–Ω–∏–≥–∏ -->
<div class="modal fade" id="bookDetailsModal" tabindex="-1" aria-labelledby="bookDetailsModalLabel"
     aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="bookTitle"></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p><strong>–ê–≤—Ç–æ—Ä:</strong> <span id="bookAuthor"></span></p>
                <p><strong>–ñ–∞–Ω—Ä:</strong> <span id="bookGenre"></span></p>
                <p><strong>–î–∞—Ç–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏:</strong> <span id="bookDate"></span></p>
                <hr/>
                <p id="bookDescription"></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–ó–∞–∫—Ä—ã—Ç—å</button>
                <!-- –ö–Ω–æ–ø–∫–∞ "–ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å" -->
                <button id="reserveButton" type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#reserveModal">
                    –ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å
                </button>
            </div>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –≤–≤–æ–¥–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –¥–Ω–µ–π –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è -->
<div class="modal fade" id="reserveModal" tabindex="-1" aria-labelledby="reserveModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="reserveModalLabel">–ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–Ω–∏–≥–∏</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <label for="reserveDays">–ù–∞ —Å–∫–æ–ª—å–∫–æ –¥–Ω–µ–π –≤—ã —Ö–æ—Ç–∏—Ç–µ –∑–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å –∫–Ω–∏–≥—É?</label>
                <input type="number" id="reserveDays" class="form-control" min="1">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                <button type="button" class="btn btn-primary">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.1.3/js/bootstrap.bundle.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const bookDetailsModal = document.getElementById('bookDetailsModal');
        const reserveButton = document.getElementById('reserveButton');

        bookDetailsModal.addEventListener('show.bs.modal', function (event) {
            const button = event.relatedTarget;
            const bookTitle = button.getAttribute('data-title');
            const bookAuthor = button.getAttribute('data-author');
            const bookGenre = button.getAttribute('data-genre');
            const bookDescription = button.getAttribute('data-description');
            const bookDate = button.getAttribute('data-date');
            const isBooked = button.getAttribute('data-booked') === 'true'; // –ü–æ–ª—É—á–∞–µ–º —Å—Ç–∞—Ç—É—Å –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è

            bookDetailsModal.querySelector('.modal-title').textContent = bookTitle;
            bookDetailsModal.querySelector('#bookAuthor').textContent = bookAuthor;
            bookDetailsModal.querySelector('#bookGenre').textContent = bookGenre;
            bookDetailsModal.querySelector('#bookDescription').textContent = bookDescription;
            bookDetailsModal.querySelector('#bookDate').textContent = bookDate;

            // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤–∏–¥–∏–º–æ—Å—Ç—å—é –∫–Ω–æ–ø–∫–∏ "–ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å"
            if (isBooked) {
                reserveButton.style.display = 'none'; // –°–∫—Ä—ã—Ç—å –∫–Ω–æ–ø–∫—É, –µ—Å–ª–∏ –∫–Ω–∏–≥–∞ –∑–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∞
            } else {
                reserveButton.style.display = 'inline-block'; // –ü–æ–∫–∞–∑–∞—Ç—å –∫–Ω–æ–ø–∫—É, –µ—Å–ª–∏ –∫–Ω–∏–≥–∞ —Å–≤–æ–±–æ–¥–Ω–∞
            }
        });
    });
</script>

</body>
</html>